{
	"name": "02_CREATE_TABLE_EXTERNAL",
	"properties": {
		"content": {
			"query": "------- SCRIPT ACTUALIZADO CON LOS DATOS DEL TRABAJO FINAL ------\n\n---- cruzando atenciones y usuarios para crear business.DimAtenciones -----\nUSE datascience2025;\nGO;\ndrop external table business.Dim_Atenciones\nCREATE EXTERNAL TABLE business.Dim_Atenciones\n WITH (\n     LOCATION = '/business/dim_atenciones/',\n     DATA_SOURCE = UPExternalDataSource,  \n     FILE_FORMAT = UPParquetFileFormat\n )  \n AS\nSELECT A.*,\nB.*,\n    Case  \n    when B.etapa_de_ejecucion like 'Líder embarazada (No cumple pre-requisitos)%' then 'No corresponde'\n    when B.etapa_de_ejecucion like 'Está en otros tratamientos (No cumple pre-requisitos)%' then 'No corresponde'\n    when B.etapa_de_ejecucion like 'Ya no es líder natura&avon%'then 'No corresponde'\n    else 'corresponde'\n    END  Alcance,\n    Case  \n    when B.etapa_de_ejecucion like 'Líder embarazada (No cumple pre-requisitos)%'           then 'No corresponde'\n    when B.etapa_de_ejecucion like 'Está en otros tratamientos (No cumple pre-requisitos)%' then 'No corresponde'\n    when B.etapa_de_ejecucion like 'Ya no es líder natura&avon%'                            then 'No corresponde'\n    when B.etapa_de_ejecucion like 'Abandonó el proceso (Exámenes faltantes o inconclusos)%'then 'Abandono'\n    when B.etapa_de_ejecucion like '%terminado%'                                            then 'Atendido'\n    when B.etapa_de_ejecucion like '%No desea el beneficio (negativa)%'                     then 'No desea'\n    when B.etapa_de_ejecucion like '%contesta%'                                             then 'No contactado'\n    when B.etapa_de_ejecucion like '%Teléfono%'                                             then 'No contactado'\n    when B.etapa_de_ejecucion like '%Caravana LPCC mensaje enviado y recibido%'             then 'Por asistir'\n    when B.etapa_de_ejecucion like '%No pudo asistir a su cita (Pierde el beneficio)%'      then 'No Asistió'\n    when B.etapa_de_ejecucion like '%Asignación monetaria realizada%'                       then 'Asignación Realizada'\n    when B.etapa_de_ejecucion like '%No se pudo brindar asignación monetaria%'              then 'Asignación No ejecutada'    \n    else 'Otros'\n    END  Seguimiento, \n    1 N,\n    B.dealtype Tratamiento\nfrom master.synLideres A\ninner join master.synAtenciones B\non A.id = B.contact_id\n\n--verificando\nselect * from business.Dim_Atenciones\n\n\n---Query edad en caso se necesite\n---SELECT fecha_de_nacimiento,DATEDIFF(year, fecha_de_nacimiento, GETDATE()) - \n---       CASE \n---           WHEN MONTH(fecha_de_nacimiento) > MONTH(GETDATE()) OR \n---                (MONTH(fecha_de_nacimiento) = MONTH(GETDATE()) AND \n---                 DAY(fecha_de_nacimiento) > DAY(GETDATE())) \n---           THEN 1 \n---           ELSE 0 \n---       END AS Edad\n---FROM master.synLideres\n\n\n---- cruzando CentrosMedicos,Atenciones y encuestas para crear business.DimCentrosMedicos -----\n\nCREATE EXTERNAL TABLE business.Dim_CentrosMedicos\n WITH (\n     LOCATION = '/business/dim_centrosmedicos/',\n     DATA_SOURCE = UPExternalDataSource,  \n     FILE_FORMAT = UPParquetFileFormat\n )  \n AS\nSelect Y.*,X.name,X.state from \n(SELECT z.[company_id] , count (*) Cantidad_lideres, avg(cast(z.[column_10] as INT)) Puntaje_Promedio\nfrom (Select A.id,B.company_id,B.contact_id,C.DNI,D.*\nfrom raw.synCentrosMedicos A\nleft join master.synAtenciones B\non A.id = B.[company_id] \nleft join master.synLideres C\non B.contact_id = C.id \nleft join master.synEncuestas D\non C.dni = D.[column_3]\n) Z \nwhere z.[company_id] is not NULL\ngroup by z.[company_id]) Y\nleft join raw.synCentrosMedicos X\non Y.company_id = X.id\n\n---\nVerificación \nselect * from business.Dim_CentrosMedicos\n\n\n\n\n\n\n\n\n-----Creando procedimiento-----\nCREATE PROCEDURE load_business_report\n@year INT,\n@result NVARCHAR (MAX) OUTPUT\nAS BEGIN\nBEGIN TRY\n    IF NULLIF(@year,'') IS NULL\n    BEGIN\n    --generative divide-by-zero error.\n    ; THROW 51007, 'Parameter not defined.',1\n    END\n    SET @result = 'Not Problem'\nEND TRY\nBEGIN CATCH\n--execute error retrieval routine. \nset @result = (SELECT ERROR_MESSAGE() AS ErrorMessage)\nEND CATCH;\nSELECT @result AS Resultado\nEND\nGO\n\n\n-----------De aquí para abajo va el código de ejemplo del profesor---------------------\n---------------------------------------------------------------------------------------\n\nUSE datascience2022;\nGO\n\nCREATE EXTERNAL TABLE business.DimPerson\n WITH (\n     LOCATION = '/business/lakehouse/dimperson/Year=2022/Month=04/',\n     DATA_SOURCE = ExternalUPDataSource,  \n     FILE_FORMAT = UPParquetFileFormat\n )  \n AS\nWITH CustomerIDNotNull (CustomerID, PersonID, CustomerAlternativeKey)  \nAS  \n(  \n    SELECT c.CustomerID, c.PersonID, c.AccountNumber\n    FROM stagingDim.Customer c \n    WHERE c.PersonID IS NOT NULL \n) \nSELECT c.CustomerID AS CustomerKey, \nc.CustomerAlternativeKey AS CustomerAlternativeKey, \np.Title AS Title, p.FirstName AS FirstName, \np.MiddleName AS MiddleName, p.LastName AS LastName,\np.Suffix AS Suffix  \nFROM stagingDim.Person p  \nINNER JOIN CustomerIDNotNull c\nON c.PersonID = p.BusinessEntityID\nINNER JOIN stagingDim.PersonPhone ph\nON c.PersonID = ph.BusinessEntityID\nINNER JOIN stagingDim.EmailAddress em\nON c.PersonID = em.BusinessEntityID\nGO\n\nCREATE EXTERNAL TABLE business.DimProduct\n WITH (\n     LOCATION = '/business/lakehouse/dimproduct/Year=2022/Month=04/',\n     DATA_SOURCE = ExternalUPDataSource,  \n     FILE_FORMAT = UPParquetFileFormat\n )  \n AS\nSELECT p.ProductID AS ProductID, \np.Name AS ProductName, \np.ProductNumber AS ProductAlternativeKey, \np.FinishedGoodsFlag AS FinishedGoodsFlag, \np.Color AS Color,\np.SafetyStockLevel AS SafetyStockLevel,\np.ReorderPoint AS ReorderPoint,\np.StandardCost AS StandardCost,\np.ListPrice AS ListPrice,\np.Size AS Size,\np.ProductLine AS ProductLine,\np.Class AS Class,\np.Style AS Style,\np.SellStartDate AS SellStartDate,\np.SellEndDate AS SellEndDate,\np.DiscontinuedDate AS DiscontinuedDate,\npc.ProductCategoryName AS ProductCategoryName,\npsc.Name AS ProductSubCategoryName\nFROM stagingDim.Product p  \nINNER JOIN stagingDim.ProductSubcategory psc\nON p.ProductSubCategoryID = psc.ProductSubCategoryID\nINNER JOIN stagingDim.ProductCategory pc\nON pc.ProductCategoryID = psc.ProductCategoryID\nGO\n\nCREATE EXTERNAL TABLE business.FactInternetSales\nWITH (\n     LOCATION = '/business/lakehouse/factinternetsales/Year=2022/Month=04/',\n     DATA_SOURCE = ExternalUPDataSource,  \n     FILE_FORMAT = UPParquetFileFormat\n)  \nAS\nSELECT\nsod.ProductID AS ProductKey,\nConvert(CHAR(8),soh.OrderDate,112) AS OrderDateKey,\nConvert(CHAR(8),soh.DueDate,112) AS DueDateKey,\nsoh.CustomerID AS CustomerKey,\nsoh.SalesOrderNumber,\nsod.SpecialOfferID AS SpecialOfferKey,\nSUM(sod.UnitPrice*sod.OrderQty) AS TotalCost,\nSUM(sod.OrderQty) AS TotalOrderQuantity,\nSUM(sod.UnitPriceDiscount) AS TotalDiscount\nFROM stagingDim.SalesOrderHeader soh \nINNER JOIN stagingDim.SalesOrderDetail sod \nON soh.SalesOrderID = sod.SalesOrderID\nGROUP BY sod.ProductID,sod.SpecialOfferID,soh.OrderDate,soh.DueDate,CustomerID,soh.SalesOrderNumber\nGO\n\n--Transacional con particion\nCREATE EXTERNAL TABLE business.DimDate(\n    DateKey INT,\n    FullDateAlternateKey DATE\n) WITH (\n    LOCATION = '/business/lakehouse/dimdate/DimDate.csv',\n    DATA_SOURCE = ExternalUPDataSource,\n    FILE_FORMAT = UPCSVWithHEADERFORMAT\n);\nGO",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "datascience2025",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}